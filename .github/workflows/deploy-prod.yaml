name: Deploy to Production

on:
  release:
    types: [published]

jobs:
  deploy-prod:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required to commit back to the repo

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Extract Release Tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Update Kustomize Image Tag
        run: |
          cd k8s/overlays/prod
          # Use kustomize edit to safely update the image tag
          # Assuming kustomize is installed or using sed as fallback
          # Ideally use kustomize edit set image ...
          # Here we use sed for simplicity if kustomize isn't available in the runner by default, 
          # but let's try to install kustomize or use a simple sed replacement for the demo.
          
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          echo "Updating Prod to version: $VERSION"
          
          # Simple sed to replace the tag
          sed -i "s/newTag: .*/newTag: $VERSION/" kustomization.yaml
          
          cat kustomization.yaml

      - name: Commit and Push Changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          git add k8s/overlays/prod/kustomization.yaml
          git commit -m "chore(release): promote version ${{ steps.get_version.outputs.VERSION }} to prod"
          git push origin main
